# 后端配置说明文档

本文档详细说明如何配置和部署驾照理论考试系统的后端服务。

## 一、环境准备

### 1.1 必需软件

1. **JDK 1.8 或更高版本**
   - 下载地址：https://www.oracle.com/java/technologies/downloads/
   - 验证安装：`java -version`

2. **Maven 3.6 或更高版本**
   - 下载地址：https://maven.apache.org/download.cgi
   - 验证安装：`mvn -version`

3. **MySQL 5.7 或更高版本**
   - 下载地址：https://dev.mysql.com/downloads/mysql/
   - 验证安装：`mysql --version`

4. **Tomcat 9.0 或更高版本**（用于部署）
   - 下载地址：https://tomcat.apache.org/download-90.cgi

### 1.2 可选工具

- **IntelliJ IDEA** 或 **Eclipse**（用于开发）
- **Postman** 或 **curl**（用于测试API）

## 二、数据库配置

### 2.1 创建数据库

1. 启动 MySQL 服务

2. 登录 MySQL：
   ```bash
   mysql -u root -p
   ```

3. 执行 SQL 脚本创建数据库和表：
   ```bash
   mysql -u root -p < backend/database/schema.sql
   ```
   
   或者手动执行：
   ```sql
   source backend/database/schema.sql;
   ```

4. 验证数据库创建成功：
   ```sql
   USE exam_db;
   SHOW TABLES;
   SELECT * FROM users;
   ```

### 2.2 修改数据库连接配置

编辑文件：`backend/src/main/java/com/exam/util/DBUtil.java`

找到以下代码并修改为你的数据库配置：

```java
private static final String DB_URL = "jdbc:mysql://localhost:3306/exam_db?useSSL=false&serverTimezone=UTC&characterEncoding=utf8";
private static final String DB_USER = "root";        // 修改为你的MySQL用户名
private static final String DB_PASSWORD = "root";    // 修改为你的MySQL密码
```

**注意**：
- 如果MySQL运行在其他主机，将 `localhost` 改为实际IP地址
- 如果MySQL使用其他端口，将 `3306` 改为实际端口
- 确保数据库用户有创建表和插入数据的权限

## 三、项目构建

### 3.1 使用 Maven 构建

1. 进入项目根目录：
   ```bash
   cd backend
   ```

2. 清理并构建项目：
   ```bash
   mvn clean package
   ```

3. 构建成功后，在 `target/` 目录下会生成 `exam-backend-1.0.0.war` 文件

### 3.2 构建常见问题

**问题1：Maven 下载依赖失败**
- 解决方案：检查网络连接，或配置国内镜像源（如阿里云镜像）

**问题2：编译错误**
- 解决方案：确保JDK版本为1.8或更高，检查 `pom.xml` 中的依赖是否正确

## 四、部署方式

### 方式一：部署到 Tomcat（生产环境推荐）

1. **停止 Tomcat**（如果正在运行）

2. **复制 WAR 文件**：
   ```bash
   cp backend/target/exam-backend-1.0.0.war /path/to/tomcat/webapps/exam-backend.war
   ```
   
   或者直接复制到 `webapps/` 目录，Tomcat会自动解压

3. **启动 Tomcat**：
   ```bash
   /path/to/tomcat/bin/startup.sh    # Linux/Mac
   # 或
   /path/to/tomcat/bin/startup.bat    # Windows
   ```

4. **验证部署**：
   - 访问：`http://localhost:8080/exam-backend/api/`
   - 应该返回404或错误页面（说明服务已启动）

5. **修改 Tomcat 端口**（可选）：
   编辑 `conf/server.xml`，找到：
   ```xml
   <Connector port="8080" protocol="HTTP/1.1" ... />
   ```
   修改为：
   ```xml
   <Connector port="8000" protocol="HTTP/1.1" ... />
   ```

### 方式二：使用 Maven Tomcat 插件（开发环境）

1. **添加插件到 pom.xml**（如果还没有）：
   ```xml
   <plugin>
       <groupId>org.apache.tomcat.maven</groupId>
       <artifactId>tomcat7-maven-plugin</artifactId>
       <version>2.2</version>
       <configuration>
           <port>8000</port>
           <path>/</path>
       </configuration>
   </plugin>
   ```

2. **运行项目**：
   ```bash
   mvn tomcat7:run
   ```

3. **访问服务**：
   - 地址：`http://localhost:8000/api/`

### 方式三：使用 IDE（开发环境推荐）

#### IntelliJ IDEA

1. **导入项目**：
   - File -> Open -> 选择 `backend` 文件夹
   - 等待 Maven 自动下载依赖

2. **配置 Tomcat**：
   - Run -> Edit Configurations
   - 点击 "+" -> Tomcat Server -> Local
   - 配置：
     - Name: Exam Backend
     - Application server: 选择已安装的Tomcat
     - Deployment: 添加 Artifact -> exam-backend:war exploded
     - Application context: `/`

3. **配置端口**：
   - 在 Server 标签页，修改 HTTP port 为 `8000`

4. **运行**：
   - 点击 Run 按钮启动

#### Eclipse

1. **导入项目**：
   - File -> Import -> Maven -> Existing Maven Projects
   - 选择 `backend` 文件夹

2. **配置 Tomcat**：
   - Window -> Preferences -> Server -> Runtime Environments
   - 添加 Tomcat 9.0
   - 右键项目 -> Properties -> Project Facets
   - 勾选 Dynamic Web Project

3. **添加到服务器**：
   - Window -> Show View -> Servers
   - 右键 -> New -> Server -> 选择 Tomcat
   - 将项目添加到服务器

4. **运行**：
   - 右键服务器 -> Start

## 五、验证部署

### 5.1 测试注册接口

使用 curl 或 Postman 测试：

```bash
curl -X POST http://localhost:8000/api/auth/register/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "test123"
  }'
```

预期响应：
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 3,
    "username": "testuser",
    "email": "test@example.com",
    "role": "user"
  }
}
```

### 5.2 测试登录接口

```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin"
  }'
```

### 5.3 测试获取题目列表

```bash
curl -X GET http://localhost:8000/api/questions/
```

## 六、前端配置

### 6.1 修改前端代理配置

编辑 `frontend/vite.config.js`，确保代理指向正确的后端地址：

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',  // 确保端口与后端一致
        changeOrigin: true
      }
    }
  }
})
```

### 6.2 启动前端

```bash
cd frontend
npm install
npm run dev
```

前端默认运行在 `http://localhost:3001`，所有 `/api` 请求会被代理到后端。

## 七、常见问题排查

### 问题1：数据库连接失败

**症状**：启动时报错 "Communications link failure"

**解决方案**：
1. 检查 MySQL 服务是否启动：`systemctl status mysql` 或 `service mysql status`
2. 检查 `DBUtil.java` 中的连接配置是否正确
3. 检查防火墙是否阻止了连接
4. 检查 MySQL 用户权限

### 问题2：端口被占用

**症状**：启动时报错 "Address already in use"

**解决方案**：
1. 查找占用端口的进程：
   ```bash
   # Linux/Mac
   lsof -i :8000
   # Windows
   netstat -ano | findstr :8000
   ```
2. 杀死进程或修改端口配置

### 问题3：CORS 跨域错误

**症状**：前端请求时报错 "CORS policy"

**解决方案**：
1. 检查 `CorsFilter.java` 是否正确配置
2. 检查 `web.xml` 中是否正确注册了 Filter
3. 确保前端请求的 Origin 在允许列表中

### 问题4：JWT Token 验证失败

**症状**：请求需要认证的接口返回 401

**解决方案**：
1. 检查请求头中是否包含 `Authorization: Bearer <token>`
2. 检查 Token 是否过期（默认24小时）
3. 重新登录获取新 Token

### 问题5：JSON 解析错误

**症状**：请求时报错 "JSON parse error"

**解决方案**：
1. 检查请求体格式是否正确
2. 检查 Content-Type 是否为 `application/json`
3. 检查 JSON 字段名是否与后端模型匹配

## 八、生产环境建议

1. **使用 HTTPS**：配置 SSL 证书
2. **数据库连接池**：使用 HikariCP 等连接池
3. **日志框架**：添加 Log4j 或 SLF4J
4. **异常处理**：添加全局异常处理器
5. **参数验证**：添加 Hibernate Validator
6. **安全加固**：
   - 修改 JWT 密钥
   - 使用更强的密码加密算法
   - 添加请求频率限制
7. **性能优化**：
   - 添加缓存（Redis）
   - 数据库索引优化
   - 静态资源 CDN

## 九、默认账户

数据库初始化后会自动创建以下账户：

- **管理员**：
  - 用户名：`admin`
  - 密码：`admin`
  
- **普通用户**：
  - 用户名：`user`
  - 密码：`password`

**重要**：生产环境请立即修改这些默认密码！

## 十、API 文档

详细的 API 接口文档请参考 `backend/README.md` 中的 "API 接口说明" 部分。

## 十一、技术支持

如遇到问题，请检查：
1. 日志文件（如果配置了日志）
2. Tomcat 控制台输出
3. 浏览器开发者工具的网络请求
4. 数据库中的数据是否正确

---

**配置完成后，你的后端服务应该可以正常运行了！**

